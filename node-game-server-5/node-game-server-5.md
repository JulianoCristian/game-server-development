#pomelo框架的设计动机与架构介绍

在本系列第一篇文章中我们介绍了游戏服务器的基础、难点、框架,以及用pomelo框架解决了运行架构的问题。 随后两篇文章我们通过示例介绍了用pomelo开发聊天服务器、捡宝游戏的开发过程。
代码示例让我们对pomelo有了很好的感性认识。现在是时候回过头来详细分析一下pomelo的设计细节，架构以及未来的发展方向了。 

## 一、Pomelo的定义和组成


以下是Pomelo官网给出的最初定义：Pomelo是基于node.js的高性能,分布式游戏服务器框架。它包括基础的开发框架和相关的扩展组件（库和工具包），可以帮助你省去游戏开发枯燥中的重复劳动和底层逻辑的开发。

Pomelo最初的设计初衷是为了游戏服务器， 不过我们在设计、开发完成后发现pomelo是个通用的分布式实时应用开发框架。它的灵活性和可扩展性使pomelo框架有了更广阔的应用范围。 由于强大的可能伸缩性和灵活性，pomelo在很多方面甚至超越了现有的开源实时应用框架。

如果你浏览一下[网易的github](https://github.com/NetEase/)，会发现pomelo远远不止是一个repository， 它是由一系列松耦合的组件组合在一起的，包括了各类demo， 各类客户端，各种库和工具。

下图是pomelo最初的组成图：
 ![pomelo框架](http://pomelo.netease.com/resource/documentImage/pomeloFramework.png)

pomelo包括以下几部分:

* 框架, 框架是pomelo最核心的部分。
* 库，pomelo提供了很多库，有些是跟游戏逻辑完全相关的，如[AI](https://github.com/NetEase/pomelo-bt)，[AOI](https://github.com/NetEase/pomelo-aoi)，[寻路](https://github.com/NetEase/pomelo-pathfinding)等；也有与游戏逻辑无关的，如[定时任务执行](https://github.com/NetEase/pomelo-scheduler)， [数据同步](https://github.com/NetEase/pomelo-sync)。
* 工具，pomelo提供了管理控制台、命令行工具、压力测试工具等一系列工具。
* 各类客户端， pomelo提供了各类平台的客户端，包括js, C, android, iOS, unity3d等，这些都可以从pomelo的官方主页查到。
* Demo， 一个框架需要强大的demo来展示功能，pomelo提供了全平台的聊天demo和[基于HTML5的捡宝Demo](https://github.com/NetEase/treasures)，系统还提供了一个强大的基于HTML5开发的强大的MMO游戏demo [Lord Of Pomelo](https://github.com/NetEase/lordofpomelo)。

而最妙的地方在于所有这些组件都是松耦合的，所有这些组件都可以独立使用。这使pomelo框架异常灵活，它可
由于篇幅有限，本篇文章只讨论pomelo框架。

## 二、游戏服务器开发的难点

### 游戏服务器运行架构的演变

网络游戏运行架构的演化可以通过下图说明：



最初的网络服务器是单进程的架构，所有的逻辑都在单台服务器内完成， 这对于同时在线要求不高的游戏是可以这么做的。由于同时在线人数的上升， 单服务器的可伸缩性必然受到挑战。



这个分布式架构与Web服务器是不同的， 以下是web服务器与游戏服务器架构的区别：

* 长连接与短连接。web应用使用基于http的短连接以达到最大的可扩展性，游戏应用采用基于socket(websocket)的长连接，以达到最大的实时性。
* 分区策略不同。web应用的分区可以根据负载均衡自由决定， 而游戏则是基于场景(area)的分区模式， 这使同场景的玩家跑在一个进程内， 以达到最少的跨进程调用。
* 有状态和无状态。web应用是无状态的， 可以达到无限的扩展。 而游戏应用则是有状态的， 由于基于场景的分区策略，它的请求必须路由到指定的服务器， 这也使游戏达不到web应用同样的可扩展性。
* 广播模式和request/response模式。web应用采用了基于request/response的请求响应模式。而游戏应用则更频繁地使用广播， 由于玩家在游戏里的行动要实时地通知场景中的其它玩家， 必须通过广播的模式实时发送。这也使游戏在网络通信上的要求高于web应用。


因此， Web应用与游戏应用的运行架构也完全不同， 下图是通常web应用与游戏应用的不同。




因为web的无状态性，它可能通过前端的负载均衡器：



而游戏应用不行， 由于它是有状态的， 必然是

各类服务器交织在一起， 互相调用。

这使游戏服务器走身了一个完全分布式的架构。


### 分布式开发与难点
#### 服务器的管理

多服务的调用




#### rpc调用，很难简化

#### 重量级的架构，导致开发效率的下降


#### 分布式事务及相关操作极其复杂

####  负载均衡，高可用


## 四、pomelo架构分析

pomelo在分布式开发上灵活地解决了这些难点。


### 灵活、轻量的进程管理

### 轻量的应用请求响应和rpc调用 

### 灵活的路由与负载均衡配置




## 五、从游戏框架到实时应用框架

当我们开发完成pomelo框架的时候，我们发现pomelo与游戏服务器没有任何关系。

### 更好的实时应用框架

pomelo游戏框架


### 支持各类客户端

### 灵活扩展




## 六、未来发展方向

### 分布式开发的模板

### 


